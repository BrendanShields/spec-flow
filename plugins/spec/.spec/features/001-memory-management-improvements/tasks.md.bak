# Tasks: Memory Management and State Transition Improvements

**Feature**: 001-memory-management-improvements
**Created**: 2025-01-03 00:45
**Total Tasks**: 23
**Estimated Time**: 18-21 hours

---

## Summary

- **P1 Tasks**: 18 tasks (15-17 hours) - Must complete
- **P2 Tasks**: 3 tasks (2-3 hours) - Should complete
- **P3 Tasks**: 2 tasks (1 hour) - Nice to have
- **Parallel Groups**: 4 groups
- **Critical Path**: T001 â†’ T002 â†’ T003 â†’ T009 â†’ T010 â†’ T013 â†’ T014 â†’ T018 (11 hours)

---

## User Story US1.1: Automated State Transitions

### Task T001: Create MemoryManager core class with singleton pattern
- **Priority**: P1
- **Estimate**: 2 hours
- **Dependencies**: None
- **Parallel**: [P] (can start immediately)
- **Files**: `.claude/hooks/src/core/memory-manager.ts`
- **User Story**: US1.1

**Description**:
Create the MemoryManager class as a singleton with lazy initialization. Implement getInstance() factory method, private constructor, and basic session state caching.

**Acceptance Criteria**:
- [ ] MemoryManager class implements singleton pattern
- [ ] getInstance(config, cwd) returns same instance
- [ ] Private constructor prevents direct instantiation
- [ ] In-memory session cache initialized
- [ ] resetInstance() method for testing
- [ ] All TypeScript strict mode checks pass

---

### Task T002: Define TypeScript types for memory system
- **Priority**: P1
- **Estimate**: 1 hour
- **Dependencies**: None
- **Parallel**: [P] (can start immediately)
- **Files**: `.claude/hooks/src/types/memory.ts`, `.claude/hooks/src/types/transaction.ts`
- **User Story**: US1.1

**Description**:
Create comprehensive TypeScript type definitions for SessionState, Transaction, FileOperation, MemoryEntry, ValidationResult, and all related types.

**Acceptance Criteria**:
- [ ] SessionState interface matches spec
- [ ] Transaction types support begin/commit/rollback
- [ ] WorkflowPhase enum defined with all phases
- [ ] All types exported from index.ts
- [ ] JSDoc comments on all public types
- [ ] No `any` types used

---

### Task T003: Implement session state cache and CRUD methods
- **Priority**: P1
- **Estimate**: 2 hours
- **Dependencies**: T001, T002
- **Parallel**: No
- **Files**: `.claude/hooks/src/core/memory-manager.ts`
- **User Story**: US1.1

**Description**:
Implement getCurrentSession(), updateSession(), saveSession(), and restoreSession() methods with in-memory caching and file persistence.

**Acceptance Criteria**:
- [ ] getCurrentSession() returns cached state
- [ ] updateSession() merges partial updates
- [ ] saveSession() persists to current-session.md
- [ ] restoreSession() loads from file
- [ ] Cache invalidation on external changes
- [ ] All methods properly typed

---

### Task T004: Implement phase transition logic
- **Priority**: P1
- **Estimate**: 2 hours
- **Dependencies**: T003
- **Parallel**: No
- **Files**: `.claude/hooks/src/core/memory-manager.ts`
- **User Story**: US1.1

**Description**:
Implement transitionPhase() and recordPhaseCompletion() methods with validation and state updates.

**Acceptance Criteria**:
- [ ] transitionPhase(from, to, metadata) validates transitions
- [ ] Invalid transitions rejected with clear errors
- [ ] Phase progress updated in session state
- [ ] recordPhaseCompletion() logs stats
- [ ] Timestamps recorded for all transitions
- [ ] Events emitted for hook integration

---

## User Story US1.2: Centralized Memory Management

### Task T005: Implement file transaction system
- **Priority**: P1
- **Estimate**: 2 hours
- **Dependencies**: T002
- **Parallel**: [P] (parallel with T003)
- **Files**: `.claude/hooks/src/utils/file-transaction.ts`
- **User Story**: US1.2

**Description**:
Create atomic file operation utilities supporting begin/commit/rollback transactions for multi-file updates.

**Acceptance Criteria**:
- [ ] beginTransaction() creates transaction object
- [ ] File operations staged in transaction
- [ ] commitTransaction() writes all files atomically
- [ ] rollbackTransaction() restores from backups
- [ ] Temp files cleaned up on completion
- [ ] Error handling with partial rollback

---

### Task T006: Add atomic multi-file update support
- **Priority**: P1
- **Estimate**: 2 hours
- **Dependencies**: T005
- **Parallel**: No
- **Files**: `.claude/hooks/src/core/memory-manager.ts`
- **User Story**: US1.2

**Description**:
Integrate file transaction system into MemoryManager for atomic updates across state and memory files.

**Acceptance Criteria**:
- [ ] All multi-file updates use transactions
- [ ] Failed updates rollback completely
- [ ] Transaction log maintained
- [ ] No partial writes to disk
- [ ] Concurrent transaction handling
- [ ] Performance < 150ms for updates

---

### Task T007: Implement memory file append methods
- **Priority**: P1
- **Estimate**: 1.5 hours
- **Dependencies**: T006
- **Parallel**: No
- **Files**: `.claude/hooks/src/core/memory-manager.ts`
- **User Story**: US1.2

**Description**:
Implement appendWorkflowProgress(), appendDecisionLog(), appendPlannedChange(), and markChangeCompleted() methods.

**Acceptance Criteria**:
- [ ] All append methods use atomic transactions
- [ ] Entries formatted per template spec
- [ ] Timestamps added automatically
- [ ] No duplicate entries allowed
- [ ] File locks prevent concurrent writes
- [ ] Progress updates include metrics

---

## User Story US1.3: Hook-Based Documentation Updates

### Task T008: Create update-memory.ts hook
- **Priority**: P1
- **Estimate**: 2 hours
- **Dependencies**: T007
- **Parallel**: [P] (parallel with T009-T011)
- **Files**: `.claude/hooks/src/hooks/memory/update-memory.ts`
- **User Story**: US1.3

**Description**:
Create generic memory update hook triggered by PostToolUse events, routing to appropriate MemoryManager methods.

**Acceptance Criteria**:
- [ ] Extends BaseHook properly
- [ ] Detects command type from context
- [ ] Routes to correct MemoryManager method
- [ ] Handles errors gracefully
- [ ] Logs all operations
- [ ] Returns structured JSON output

---

### Task T009: Create validate-state.ts hook
- **Priority**: P1
- **Estimate**: 2 hours
- **Dependencies**: T011
- **Parallel**: [P] (parallel with T008, T010)
- **Files**: `.claude/hooks/src/hooks/memory/validate-state.ts`
- **User Story**: US1.3

**Description**:
Create PreToolUse hook that validates state before any write operations to .spec/state/ files.

**Acceptance Criteria**:
- [ ] Intercepts writes to state files
- [ ] Validates schema before allowing write
- [ ] Blocks writes not from MemoryManager
- [ ] Clear error messages on violations
- [ ] Allows MemoryManager writes via env var
- [ ] Performance < 50ms validation

---

### Task T010: Create track-transitions.ts hook
- **Priority**: P1
- **Estimate**: 1.5 hours
- **Dependencies**: T004
- **Parallel**: [P] (parallel with T008, T009)
- **Files**: `.claude/hooks/src/hooks/memory/track-transitions.ts`
- **User Story**: US1.3

**Description**:
Create PostToolUse hook that tracks phase transitions and logs to WORKFLOW-PROGRESS.md.

**Acceptance Criteria**:
- [ ] Detects phase changes from command context
- [ ] Calls MemoryManager.transitionPhase()
- [ ] Logs transition to WORKFLOW-PROGRESS.md
- [ ] Updates current-session.md phase
- [ ] Calculates transition duration
- [ ] Emits transition events

---

### Task T011: Update session-init.ts to initialize MemoryManager
- **Priority**: P1
- **Estimate**: 1 hour
- **Dependencies**: T001
- **Parallel**: No
- **Files**: `.claude/hooks/src/hooks/session/session-init.ts`
- **User Story**: US1.3

**Description**:
Enhance existing session-init hook to initialize MemoryManager singleton on SessionStart event.

**Acceptance Criteria**:
- [ ] Calls MemoryManager.getInstance()
- [ ] Loads or creates session state
- [ ] Validates existing state
- [ ] Runs migration if needed
- [ ] Reports initialization status
- [ ] Handles initialization failures

---

### Task T012: Update save-session.ts to use MemoryManager
- **Priority**: P1
- **Estimate**: 0.5 hours
- **Dependencies**: T003
- **Parallel**: No
- **Files**: `.claude/hooks/src/hooks/session/save-session.ts`
- **User Story**: US1.3

**Description**:
Refactor save-session hook to use MemoryManager.saveSession() instead of direct file writes.

**Acceptance Criteria**:
- [ ] Calls MemoryManager.saveSession()
- [ ] Removes direct file write code
- [ ] Maintains backward compatibility
- [ ] Error handling preserved
- [ ] Logging updated
- [ ] Performance unchanged

---

### Task T013: Update restore-session.ts to use MemoryManager
- **Priority**: P1
- **Estimate**: 0.5 hours
- **Dependencies**: T003
- **Parallel**: No
- **Files**: `.claude/hooks/src/hooks/session/restore-session.ts`
- **User Story**: US1.3

**Description**:
Refactor restore-session hook to use MemoryManager.restoreSession() instead of direct file reads.

**Acceptance Criteria**:
- [ ] Calls MemoryManager.restoreSession()
- [ ] Removes direct file read code
- [ ] Session suggestions still generated
- [ ] Error handling preserved
- [ ] Logging updated
- [ ] Performance unchanged

---

## User Story US1.4: State Validation and Recovery

### Task T014: Create state validator with JSON Schema
- **Priority**: P1
- **Estimate**: 2 hours
- **Dependencies**: T002
- **Parallel**: No
- **Files**: `.claude/hooks/src/core/state-validator.ts`, `.claude/hooks/src/schemas/session-state.schema.json`
- **User Story**: US1.4

**Description**:
Implement state validation using JSON Schema (Ajv) to validate SessionState structure and values.

**Acceptance Criteria**:
- [ ] JSON Schema defines SessionState structure
- [ ] Validator validates YAML frontmatter
- [ ] All required fields checked
- [ ] Enum values validated
- [ ] Timestamps validated as ISO 8601
- [ ] Custom validators for feature ID

---

### Task T015: Implement validateState() and detectInconsistencies()
- **Priority**: P1
- **Estimate**: 2 hours
- **Dependencies**: T014
- **Parallel**: No
- **Files**: `.claude/hooks/src/core/memory-manager.ts`
- **User Story**: US1.4

**Description**:
Add validateState() and detectInconsistencies() methods to MemoryManager with comprehensive validation rules.

**Acceptance Criteria**:
- [ ] validateState() returns ValidationResult
- [ ] Detects orphaned state (no spec.md)
- [ ] Detects invalid phase values
- [ ] Detects timestamp inconsistencies
- [ ] detectInconsistencies() checks cross-file consistency
- [ ] Warnings for non-critical issues

---

### Task T016: Implement auto-recovery with repairState()
- **Priority**: P1
- **Estimate**: 2 hours
- **Dependencies**: T015
- **Parallel**: No
- **Files**: `.claude/hooks/src/core/state-recovery.ts`
- **User Story**: US1.4

**Description**:
Create automatic state recovery logic that fixes common corruption issues without user intervention.

**Acceptance Criteria**:
- [ ] Repairs missing required fields
- [ ] Resets invalid phase to "none"
- [ ] Restores from last snapshot on corruption
- [ ] Logs all repairs performed
- [ ] Returns RepairReport with details
- [ ] Never destructive (backups first)

---

### Task T017: Add schema validation to all state writes
- **Priority**: P1
- **Estimate**: 1 hour
- **Dependencies**: T014, T006
- **Parallel**: No
- **Files**: `.claude/hooks/src/core/memory-manager.ts`
- **User Story**: US1.4

**Description**:
Integrate state validator into all MemoryManager write operations to validate before persistence.

**Acceptance Criteria**:
- [ ] All saveSession() calls validate first
- [ ] Invalid state rejected with errors
- [ ] Validation errors logged with details
- [ ] Performance < 50ms for validation
- [ ] Validation can be disabled for testing
- [ ] Clear error messages to users

---

## User Story US1.5: Session Continuity

### Task T018: Enhance session restoration with context tracking
- **Priority**: P1
- **Estimate**: 1.5 hours
- **Dependencies**: T013
- **Parallel**: No
- **Files**: `.claude/hooks/src/hooks/session/restore-session.ts`
- **User Story**: US1.5

**Description**:
Enhance session restoration to track recently modified files, pending tasks, and provide context-aware suggestions.

**Acceptance Criteria**:
- [ ] Tracks files modified in last session
- [ ] Loads pending tasks from tasks.md
- [ ] Calculates time since last session
- [ ] Generates context-aware suggestions
- [ ] Highlights incomplete work
- [ ] Session continuity score calculated

---

## User Story US2.1: State Change History (P2)

### Task T019: Implement state history logging
- **Priority**: P2
- **Estimate**: 1.5 hours
- **Dependencies**: T006
- **Parallel**: No
- **Files**: `.claude/hooks/src/core/memory-manager.ts`
- **User Story**: US2.1

**Description**:
Add state change history logging to capture all mutations with timestamps and context.

**Acceptance Criteria**:
- [ ] All state changes logged to history/
- [ ] Logs include timestamp, operation, files
- [ ] History files are JSON format
- [ ] Queryable via helper methods
- [ ] History cleanup (30 day retention)
- [ ] Export capability for analysis

---

## User Story US2.2: Cross-Session Analytics (P2)

### Task T020: Add session metrics aggregation
- **Priority**: P2
- **Estimate**: 1.5 hours
- **Dependencies**: T018, T019
- **Parallel**: No
- **Files**: `.claude/hooks/src/core/session-analytics.ts`
- **User Story**: US2.2

**Description**:
Implement analytics aggregation across multiple sessions to track velocity, phase durations, and bottlenecks.

**Acceptance Criteria**:
- [ ] Aggregates metrics from history logs
- [ ] Calculates phase duration averages
- [ ] Identifies bottleneck phases
- [ ] Velocity trends over time
- [ ] Export to CSV/JSON formats
- [ ] Performance < 500ms for 100 sessions

---

## User Story US2.3: State Migration Support (P2)

### Task T021: Create migration utility for .session.json
- **Priority**: P1 (critical for backward compatibility)
- **Estimate**: 1.5 hours
- **Dependencies**: T003
- **Parallel**: No
- **Files**: `.claude/hooks/src/utils/migrate-session.ts`
- **User Story**: US2.3

**Description**:
Create migration utility that converts legacy .session.json format to new current-session.md format.

**Acceptance Criteria**:
- [ ] Detects .session.json on SessionStart
- [ ] Converts to current-session.md format
- [ ] Backs up original as .session.json.backup
- [ ] Logs migration success
- [ ] Adds 30-day expiry to backup
- [ ] Migration idempotent (safe to re-run)

---

## User Story US3.1: State Visualization Dashboard (P3)

### Task T022: Create snapshot system with retention policy
- **Priority**: P2 (enables recovery features)
- **Estimate**: 2 hours
- **Dependencies**: T006
- **Parallel**: No
- **Files**: `.claude/hooks/src/core/snapshot-manager.ts`
- **User Story**: US3.1

**Description**:
Implement snapshot creation, listing, restoration, and automatic cleanup with 30-day retention policy.

**Acceptance Criteria**:
- [ ] createSnapshot(label) creates timestamped snapshot
- [ ] Snapshots stored in .spec/state/snapshots/
- [ ] listSnapshots() returns sorted list
- [ ] restoreSnapshot(id) restores from snapshot
- [ ] deleteOldSnapshots() applies retention policy
- [ ] Snapshot includes file hashes

---

### Task T023: Add snapshot-state.ts periodic hook
- **Priority**: P3
- **Estimate**: 0.5 hours
- **Dependencies**: T022
- **Parallel**: No
- **Files**: `.claude/hooks/src/hooks/memory/snapshot-state.ts`
- **User Story**: US3.1

**Description**:
Create periodic hook that automatically snapshots state every 5 minutes during active sessions.

**Acceptance Criteria**:
- [ ] Triggered periodically (5 min interval)
- [ ] Calls SnapshotManager.createSnapshot()
- [ ] Runs in background (non-blocking)
- [ ] Logs snapshot creation
- [ ] Skips if no changes since last snapshot
- [ ] Performance < 200ms

---

## Dependency Graph

```
Foundation (can start immediately):
  T001 [P] â†’ T003 â†’ T004 â†’ T010
  T002 [P] â†’ T005 â†’ T006 â†’ T007 â†’ T008

Validation Path:
  T002 â†’ T014 â†’ T015 â†’ T016
  T014, T006 â†’ T017

Hooks Integration:
  T001 â†’ T011
  T003 â†’ T012, T013 â†’ T018
  T007 â†’ T008 [P], T010 [P]
  T011 â†’ T009 [P]

Advanced Features:
  T006 â†’ T019, T022
  T018, T019 â†’ T020
  T003 â†’ T021
  T022 â†’ T023
```

---

## Parallel Work Opportunities

### Group 1: Foundation (Start Immediately)
- **T001**: Create MemoryManager core [P] - 2h
- **T002**: Define TypeScript types [P] - 1h

**Time Savings**: 1 hour (parallel vs sequential)

### Group 2: After Foundation
- **T005**: File transaction system [P] - 2h
- **T014**: State validator [P] - 2h

**Time Savings**: 2 hours

### Group 3: Hook Implementation
- **T008**: update-memory.ts hook [P] - 2h
- **T009**: validate-state.ts hook [P] - 2h
- **T010**: track-transitions.ts hook [P] - 1.5h

**Time Savings**: 3.5 hours

### Group 4: Session Hooks
- **T012**: Update save-session.ts [P] - 0.5h
- **T013**: Update restore-session.ts [P] - 0.5h

**Time Savings**: 0.5 hours

**Total Parallel Time Savings**: ~7 hours (reduces 21h to 14h with parallelization)

---

## Implementation Order

### Phase 1: Core Infrastructure (5-6 hours)
1. T001, T002 (parallel start)
2. T003 (session state CRUD)
3. T004 (phase transitions)
4. T005 (file transactions, parallel with T014)
5. T014 (state validator, parallel with T005)

### Phase 2: Memory Management (4-5 hours)
6. T006 (atomic updates)
7. T007 (memory file appends)
8. T015 (validation methods)
9. T016 (auto-recovery)
10. T017 (validation integration)

### Phase 3: Hook Integration (5-6 hours)
11. T011 (session-init update)
12. T008, T009, T010 (parallel: memory hooks)
13. T012, T013 (parallel: session hooks)
14. T018 (enhanced restoration)

### Phase 4: Advanced Features (3-4 hours)
15. T021 (migration utility) - P1, do early
16. T019 (history logging)
17. T022 (snapshot system)
18. T020 (analytics)
19. T023 (periodic snapshots)

---

## Risk Mitigation

### High Risk Tasks
- **T006**: Atomic transactions (complex, critical path)
  - Mitigation: Extensive unit tests, manual rollback testing
- **T009**: State validation hook (must not break writes)
  - Mitigation: Thorough testing with existing workflows
- **T021**: Migration (data loss risk)
  - Mitigation: Always backup before migration, idempotent design

### Dependencies to Watch
- T006 blocks many tasks (T007, T008, T019, T022)
  - Plan: Prioritize T006 early, parallelize T005/T014 while building
- Hook updates (T011-T013) could break existing workflows
  - Plan: Test each hook individually before integrating

---

## Testing Requirements

### Unit Tests (per task)
- Each task must include unit tests
- Coverage target: 90% for core MemoryManager
- Coverage target: 80% for hooks

### Integration Tests
- Full workflow: init â†’ generate â†’ plan â†’ tasks â†’ implement
- Session interruption and resume
- State corruption and recovery
- Snapshot create and restore
- Migration from legacy format

### Manual Testing
- Run on real project with existing state
- Test backward compatibility
- Verify no data loss during migration
- Validate all hooks execute correctly

---

## Next Steps

1. **Review task breakdown** - Ensure all requirements covered
2. **Run implement phase** - Execute tasks in dependency order
3. **Track progress** - Update current-session.md as tasks complete
4. **Create checkpoints** - Snapshot after each phase

**Command to start implementation**:
```bash
/workflow:spec â†’ "ðŸ”¨ Continue Building" â†’ Execute tasks
```

---

*Task breakdown generated by Spec Workflow System v3.3.0*
*Ready for implementation!*
